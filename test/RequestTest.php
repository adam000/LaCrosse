<?php
require_once('base.php');

class RequestTest extends PHPUnit_Framework_TestCase
{
    public function testWeatherUndergroundData()
    {
        $packet = file_get_contents('test/packets/197-byte-weather.dump');
        $nybs = post2nyb($packet);

        $wuData = assembleWUData($nybs, 1);

        $expected = "&tempf=52.88&humidity=82&dewptf=48.86&indoortempf=68.36&indoorhumidity=59&windspeedmph=0.00&windgustmph=0.00&winddir=270&baromin=29.91&rainin=0.00&dailyrainin=0.00&softwaretype=phpLaxWeatherBro";
        $this->assertEquals($expected, $wuData);
    }

    public function testLogData()
    {
        $packet = file_get_contents('test/packets/197-byte-weather.dump');
        $nybs = post2nyb($packet);

        $logData = assembleLogData($nybs, $packet);

        $expected = '\d{4}-[01][0-9]-[01][0-9] [0-2][0-9]:[0-5][0-9]:[0-5][0-9]   Packet Type 01\:01
 Outdoor\: Temp\:52.88 Max\:97.88 07\/19\/15-02\:46 Min\:3.38 02\/20\/15-07\:02 Humidity\: 82 Max\:93 06\/28\/15-08\:27 Min\:17 04\/05\/15-04\:51\s
  Indoor\: Temp\:68.36 Max\:139.82 11\/24\/15-03\:45 Min\:-39.28 11\/24\/15-12\:31 Humidity\: 59 Max\:81 07\/19\/15-02\:12 Min\:1 11\/24\/15-10\:58\s
 Windsp\:0.00 Gust\:0.00 Max Gust\:9.56 Max Gust Time\:12\/07\/15-11\:19 WindDir\: W   W   W   W   W   W   Barometer\: 29.91 Min\: 10.88 Max\: 32.59\s
 Rain\: 1hr\: 0.00 24hr\: 0.00 Week\: 10.83 Month\: 0.00 Since Reset\: 10.83 Reset\: 00\/00\/00-00\:10 Last Heavy Rain Ended\: 12\/10\/15-21\:47\s
 Unknown Dates\: 0x051\:07\/19\/15-02\:46 0x05b\:02\/15\/15-05\:49 0x0d4\:12\/10\/15-21\:47 0x112\:01\/01\/13-00\:00 0x16c\:11\/24\/15-13\:07 0x176\:11\/24\/15-14\:50\s
 Checksums for all but last two bytes\: CRC16\: 07d2

       \|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|1\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|2\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3\|3
by nyb \|0\|1\|2\|3\|4\|5\|6\|7\|8\|9\|a\|b\|c\|d\|e\|f\|0\|1\|2\|3\|4\|5\|6\|7\|8\|9\|a\|b\|c\|d\|e\|f\|0\|1\|2\|3\|4\|5\|6\|7\|8\|9\|a\|b\|c\|d\|e\|f\|0\|1\|2\|3\|4\|5\|6\|7\|8\|9\|a\|b\|c\|d\|e\|f
00 000 \| \| \|1\|e\|3\|0\|2\|0\|0\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|0\|0\| \| \| \|0\|0\| \| \| \|0\|0\|0\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|\s
20 040 \| \| \| \| \|0\|0\| \| \| \|0\|0\| \| \| \|0\|0\|8\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|7\|6\|6\|0\|0\|1\|3\|8\|0\|0\| \| \| \|0\|0\| \| \| \| \| \| \| \| \| \| \| \|\s
40 080 \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\| \| \| \| \| \| \| \|0
60 0c0 \|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\|0\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|0\|0\|0\|0\|0\|0\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|0\|0\|0\|0\|0\|0\| \| \| \| \| \|\s
80 100 \|0\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|0\|0\|0\|0\|0\|0\| \| \| \| \|0\|0\|5\|0\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|0\|0
a0 140 \| \| \| \| \|0\|0\|1\|0\| \| \| \| \| \| \|0\| \| \| \| \|1\|0\|1\|2\|8\|0\| \| \| \| \|0\|3\|6\|8\|4\|0\| \| \| \| \|1\|1\|0\|3\|6\| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \| \|\s
c0 180 \|0\|4\|5\|3\|0\|7
        117 out of 394 nybbles are unknown';
        $this->assertRegexp("/$expected/m", $logData);
    }
}


